"""
Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«ç”»åƒè§£æã‚·ã‚¹ãƒ†ãƒ ã®Streamlit UIã‚’æä¾›ã—ã¾ã™ã€‚
ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€åˆ†æå®Ÿè¡Œã€çµæœè¡¨ç¤ºã€ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›ãªã©ã®æ©Ÿèƒ½ã‚’å«ã¿ã¾ã™ã€‚
"""

import os
import sys
import logging
import asyncio
import time
from pathlib import Path
from typing import List, Dict, Any, Optional, Tuple
from datetime import datetime
import io

import streamlit as st
import pandas as pd
from PIL import Image

# ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã®å®šç¾©
SESSION_PROCESSOR = "processor"
SESSION_RESULTS = "results"
SESSION_PROCESSING = "is_processing"
SESSION_PROCESSED = "is_processed"
SESSION_USE_CACHE = "use_cache"
SESSION_CONFIG = "config"
SESSION_API_WARNING = "api_key_warning_shown"
SESSION_UPLOADER = "uploader"
SESSION_DEV_MODE = "dev_mode"
SESSION_SALON_URL = "salon_url"
SESSION_STYLISTS = "stylists"
SESSION_COUPONS = "coupons"
SESSION_PROGRESS = "progress"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³
APP_VERSION = "1.0.0"

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
os.environ["PYTHONIOENCODING"] = "utf-8"

SESSION_DEV_MODE = "dev_mode"

# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from hairstyle_analyzer.data.config_manager import ConfigManager
from hairstyle_analyzer.data.template_manager import TemplateManager
from hairstyle_analyzer.data.cache_manager import CacheManager
from hairstyle_analyzer.services.scraper.scraper_service import ScraperService

# ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
from hairstyle_analyzer.core.template_matcher import TemplateMatcher
from hairstyle_analyzer.core.image_analyzer import ImageAnalyzer
from hairstyle_analyzer.core.style_matching import StyleMatchingService
from hairstyle_analyzer.core.excel_exporter import ExcelExporter
from hairstyle_analyzer.core.processor import MainProcessor

# æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«é–¢é€£ã™ã‚‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# â€»ã“ã‚Œã‚‰ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹ãŒç¾åœ¨ã®æ§‹é€ ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¾ã™
# from hairstyle_analyzer.services.gemini_service import GeminiService
# from hairstyle_analyzer.analyzer.style_analyzer import StyleAnalyzer
# from hairstyle_analyzer.analyzer.attribute_analyzer import AttributeAnalyzer
# from hairstyle_analyzer.expert.matchmaking_expert import MatchmakingExpert
# from hairstyle_analyzer.recommender.style_recommender import StyleRecommender
# from hairstyle_analyzer.processor.style_processor import StyleProcessor

# å®Ÿéš›ã«ä½¿ç”¨å¯èƒ½ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆä¸Šè¨˜ã®ä»£æ›¿ã¨ã—ã¦ï¼‰
from hairstyle_analyzer.services.gemini.gemini_service import GeminiService

# UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
from hairstyle_analyzer.utils.async_context import progress_tracker

from hairstyle_analyzer.data.models import ProcessResult, StyleAnalysis, AttributeAnalysis, Template, StylistInfo, CouponInfo


def initialize_session_state():
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã™ã‚‹"""
    # å‡¦ç†æ¸ˆã¿ç”»åƒã®æ ¼ç´ç”¨
    if SESSION_RESULTS not in st.session_state:
        st.session_state[SESSION_RESULTS] = {}
    
    # å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
    if SESSION_PROCESSING not in st.session_state:
        st.session_state[SESSION_PROCESSING] = False
    
    # å‡¦ç†æ¸ˆã¿ãƒ•ãƒ©ã‚°
    if SESSION_PROCESSED not in st.session_state:
        st.session_state[SESSION_PROCESSED] = False
    
    # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    if SESSION_PROCESSOR not in st.session_state:
        st.session_state[SESSION_PROCESSOR] = None
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®š
    if SESSION_USE_CACHE not in st.session_state:
        st.session_state[SESSION_USE_CACHE] = True
    
    # ã‚µãƒ­ãƒ³URLè¨­å®š
    if SESSION_SALON_URL not in st.session_state:
        st.session_state[SESSION_SALON_URL] = ""
    
    # APIã‚­ãƒ¼è­¦å‘Šè¡¨ç¤ºãƒ•ãƒ©ã‚°
    if SESSION_API_WARNING not in st.session_state:
        st.session_state[SESSION_API_WARNING] = False
    
    # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚­ãƒ¼
    if SESSION_UPLOADER not in st.session_state:
        st.session_state[SESSION_UPLOADER] = "uploader"
    
    # é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰
    if SESSION_DEV_MODE not in st.session_state:
        st.session_state[SESSION_DEV_MODE] = False


def update_progress(current, total, message=""):
    """é€²æ—çŠ¶æ³ã®æ›´æ–°"""
    if SESSION_PROGRESS in st.session_state:
        progress = st.session_state[SESSION_PROGRESS]
        progress["current"] = current
        progress["total"] = total
        progress["message"] = message
        
        # å®Œäº†æ™‚ã®å‡¦ç†
        if current >= total and total > 0:
            progress["complete"] = True
        
        st.session_state[SESSION_PROGRESS] = progress


async def process_images(processor, image_paths, stylists=None, coupons=None, use_cache=True):
    """ç”»åƒã‚’å‡¦ç†ã—ã¦çµæœã‚’å–å¾—ã™ã‚‹éåŒæœŸé–¢æ•°"""
    results = []
    total = len(image_paths)
    
    # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒNoneã®å ´åˆã€å†åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
    if processor is None:
        logging.error("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒNoneã®ãŸã‚ã€å†åˆæœŸåŒ–ã‚’è©¦ã¿ã¾ã™")
        try:
            config_manager = get_config_manager()
            processor = create_processor(config_manager)
            if processor is None:
                logging.error("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®å†åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ")
                return []
            # å†åˆæœŸåŒ–ãŒæˆåŠŸã—ãŸå ´åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
            st.session_state[SESSION_PROCESSOR] = processor
            logging.info("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®å†åˆæœŸåŒ–ã«æˆåŠŸã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ")
        except Exception as e:
            logging.error(f"ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®å†åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
            return []
    
    # ç”»åƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if not image_paths:
        logging.error("ç”»åƒãƒ‘ã‚¹ãŒç©ºã§ã™")
        return []
    
    # é€²æ—çŠ¶æ³ã®åˆæœŸåŒ–
    progress = {
        "current": 0,
        "total": total,
        "message": "åˆæœŸåŒ–ä¸­...",
        "start_time": time.time(),
        "complete": False
    }
    st.session_state[SESSION_PROGRESS] = progress
    
    try:
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã‚’é©ç”¨
        processor.use_cache = use_cache
        
        # å„ç”»åƒã‚’å‡¦ç†
        for i, image_path in enumerate(image_paths):
            try:
                # é€²æ—çŠ¶æ³ã®æ›´æ–°
                progress["current"] = i
                progress["message"] = f"ç”»åƒ {i+1}/{total} ã‚’å‡¦ç†ä¸­..."
                st.session_state[SESSION_PROGRESS] = progress
                
                # æ–‡å­—åˆ—ãƒ‘ã‚¹ã‚’Pathã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                path_obj = Path(image_path) if isinstance(image_path, str) else image_path
                
                # ãƒ­ã‚°ã«è¨˜éŒ²
                image_name = path_obj.name
                logging.info(f"ç”»åƒ {image_name} ã®å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™")
                
                # ç”»åƒå‡¦ç†
                if stylists and coupons:
                    # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã‚¯ãƒ¼ãƒãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦å‡¦ç†
                    result = await processor.process_single_image(path_obj, stylists, coupons, use_cache=use_cache)
                else:
                    # åŸºæœ¬å‡¦ç†
                    result = await processor.process_single_image(path_obj, use_cache=use_cache)
                
                # çµæœã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿½åŠ 
                if result:
                    if isinstance(result, dict) and 'image_name' not in result:
                        result['image_name'] = image_name
                        result['image_path'] = str(path_obj)
                    results.append(result)
                
            except Exception as e:
                # å€‹åˆ¥ã®ç”»åƒå‡¦ç†ä¸­ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆå‡¦ç†ã¯ç¶šè¡Œï¼‰
                logging.error(f"ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼ ({image_name}): {str(e)}")
                import traceback
                logging.error(traceback.format_exc())
                continue
        
        # é€²æ—çŠ¶æ³ã®æ›´æ–°
        progress["current"] = total
        progress["message"] = "å‡¦ç†å®Œäº†"
        progress["complete"] = True
        st.session_state[SESSION_PROGRESS] = progress
        
        return results
    
    except Exception as e:
        # å…¨ä½“ã®å‡¦ç†ä¸­ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        logging.error(f"ç”»åƒå‡¦ç†å…¨ä½“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        import traceback
        logging.error(traceback.format_exc())
        return []


def create_processor(config_manager):
    """ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’ä½œæˆã™ã‚‹é–¢æ•°"""
    try:
        logging.info("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®ä½œæˆã‚’é–‹å§‹ã—ã¾ã™")
        
        # è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒNoneã®å ´åˆã®å¯¾å¿œ
        if config_manager is None:
            logging.error("è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒNoneã§ã™")
            return None
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        template_manager = TemplateManager(config_manager.paths.template_csv)
        logging.info(f"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: {config_manager.paths.template_csv}")
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ç¢ºèª
        if not template_manager:
            logging.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ")
            return None
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        cache_manager = CacheManager(config_manager.paths.cache_file, config_manager.cache)
        logging.info(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«: {config_manager.paths.cache_file}")
        
        # GeminiServiceã®åˆæœŸåŒ–
        try:
            gemini_service = GeminiService(config_manager.gemini)
            
            # APIã‚­ãƒ¼ã®ç¢ºèªã¨è¨­å®š
            api_key = get_api_key()
            if api_key:
                # APIã‚­ãƒ¼ã®è¨­å®šã‚’è©¦ã¿ã‚‹
                try:
                    gemini_service.set_api_key(api_key)
                    logging.info("APIã‚­ãƒ¼ã‚’æ­£å¸¸ã«è¨­å®šã—ã¾ã—ãŸ")
                except Exception as e:
                    logging.error(f"APIã‚­ãƒ¼è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
            else:
                logging.warning("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä¸€éƒ¨ã®æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™")
        except Exception as e:
            logging.error(f"GeminiServiceåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
            gemini_service = None
        
        logging.info(f"Gemini APIè¨­å®š: ãƒ¢ãƒ‡ãƒ«={config_manager.gemini.model}")
        
        # å„ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–
        image_analyzer = ImageAnalyzer(gemini_service, cache_manager)
        template_matcher = TemplateMatcher(template_manager)
        style_matcher = StyleMatchingService(gemini_service)
        excel_exporter = ExcelExporter(config_manager.excel)
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®šã®å–å¾—
        use_cache = st.session_state.get(SESSION_USE_CACHE, True)
        logging.info(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®š: {use_cache}")
        
        # ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®åˆæœŸåŒ–
        processor = MainProcessor(
            image_analyzer=image_analyzer,
            template_matcher=template_matcher,
            style_matcher=style_matcher,
            excel_exporter=excel_exporter,
            cache_manager=cache_manager,
            batch_size=config_manager.processing.batch_size,
            api_delay=config_manager.processing.api_delay,
            use_cache=use_cache
        )
        
        logging.info("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ")
        return processor
        
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        logging.error(f"ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        import traceback
        logging.error(traceback.format_exc())
        return None


def display_progress():
    """é€²æ—çŠ¶æ³ã®è¡¨ç¤º"""
    if SESSION_PROGRESS in st.session_state:
        progress = st.session_state[SESSION_PROGRESS]
        current = progress["current"]
        total = progress["total"]
        message = progress["message"]
        
        if total > 0:
            # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¡¨ç¤º
            progress_val = min(current / total, 1.0)
            progress_bar = st.progress(progress_val)
            
            # é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            if message:
                st.write(f"çŠ¶æ…‹: {message}")
            
            # å‡¦ç†æ™‚é–“ã®è¡¨ç¤º
            if progress["start_time"]:
                elapsed = time.time() - progress["start_time"]
                if elapsed < 60:
                    st.write(f"çµŒéæ™‚é–“: {elapsed:.1f}ç§’")
                else:
                    minutes = int(elapsed // 60)
                    seconds = int(elapsed % 60)
                    st.write(f"çµŒéæ™‚é–“: {minutes}åˆ†{seconds}ç§’")
                
                # æ®‹ã‚Šæ™‚é–“ã®äºˆæ¸¬ï¼ˆç¾åœ¨ã®é€²æ—ã‹ã‚‰ï¼‰
                if 0 < current < total:
                    remaining = (elapsed / current) * (total - current)
                    if remaining < 60:
                        st.write(f"æ¨å®šæ®‹ã‚Šæ™‚é–“: {remaining:.1f}ç§’")
                    else:
                        minutes = int(remaining // 60)
                        seconds = int(remaining % 60)
                        st.write(f"æ¨å®šæ®‹ã‚Šæ™‚é–“: {minutes}åˆ†{seconds}ç§’")
            
            # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if progress["complete"]:
                st.success(f"å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ: {current}/{total}ç”»åƒ")


def display_results(results):
    """å‡¦ç†çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    if not results:
        st.warning("è¡¨ç¤ºã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return
    
    st.subheader("å‡¦ç†çµæœ")
    
    # çµæœãƒ‡ãƒ¼ã‚¿ã‚’DataFrameã«å¤‰æ›
    data = []
    for result in results:
        # çµæœãŒè¾æ›¸å‹ã‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã‹ç¢ºèª
        try:
            if isinstance(result, dict):
                # è¾æ›¸å‹ã®å ´åˆ
                image_name = result.get('image_name', 'ä¸æ˜')
                
                # style_analysisã®å–å¾—
                style_analysis = result.get('style_analysis', {})
                if isinstance(style_analysis, dict):
                    category = style_analysis.get('category', '')
                else:
                    category = getattr(style_analysis, 'category', '')
                
                # attribute_analysisã®å–å¾—
                attribute_analysis = result.get('attribute_analysis', {})
                if isinstance(attribute_analysis, dict):
                    sex = attribute_analysis.get('sex', '')
                    length = attribute_analysis.get('length', '')
                else:
                    sex = getattr(attribute_analysis, 'sex', '')
                    length = getattr(attribute_analysis, 'length', '')
                
                # selected_templateã®å–å¾—
                selected_template = result.get('selected_template', {})
                if isinstance(selected_template, dict):
                    title = selected_template.get('title', '')
                    comment = selected_template.get('comment', '')
                    menu = selected_template.get('menu', '')
                    hashtag = selected_template.get('hashtag', '')
                else:
                    title = getattr(selected_template, 'title', '')
                    comment = getattr(selected_template, 'comment', '')
                    menu = getattr(selected_template, 'menu', '')
                    hashtag = getattr(selected_template, 'hashtag', '')
                
                # selected_stylistã®å–å¾—
                selected_stylist = result.get('selected_stylist', {})
                if isinstance(selected_stylist, dict):
                    stylist_name = selected_stylist.get('name', '')
                else:
                    stylist_name = getattr(selected_stylist, 'name', '')
                
                # selected_couponã®å–å¾—
                selected_coupon = result.get('selected_coupon', {})
                if isinstance(selected_coupon, dict):
                    coupon_name = selected_coupon.get('name', '')
                else:
                    coupon_name = getattr(selected_coupon, 'name', '')
            else:
                # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å ´åˆ
                image_name = getattr(result, 'image_name', 'ä¸æ˜')
                category = getattr(result.style_analysis, 'category', '')
                sex = getattr(result.attribute_analysis, 'sex', '')
                length = getattr(result.attribute_analysis, 'length', '')
                title = getattr(result.selected_template, 'title', '')
                comment = getattr(result.selected_template, 'comment', '')
                menu = getattr(result.selected_template, 'menu', '')
                hashtag = getattr(result.selected_template, 'hashtag', '')
                stylist_name = getattr(result.selected_stylist, 'name', '')
                coupon_name = getattr(result.selected_coupon, 'name', '')
            
            # ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ  - Excelã¨åŒã˜é †åºã§è¡¨ç¤º
            data.append({
                "ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆå": stylist_name,
                "ã‚¯ãƒ¼ãƒãƒ³å": coupon_name,
                "ã‚³ãƒ¡ãƒ³ãƒˆ": comment,
                "ã‚¹ã‚¿ã‚¤ãƒ«ã‚¿ã‚¤ãƒˆãƒ«": title,
                "æ€§åˆ¥": sex,
                "é•·ã•": length,
                "ã‚¹ã‚¿ã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼": menu,
                "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°": hashtag,
                "ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å": image_name
            })
        except Exception as e:
            st.error(f"çµæœã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            st.write(f"çµæœã®å½¢å¼: {type(result)}")
            if isinstance(result, dict):
                st.write(f"çµæœã®ã‚­ãƒ¼: {list(result.keys())}")
    
    df = pd.DataFrame(data)
    
    # æ¦‚è¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
    st.write("### çµæœæ¦‚è¦")
    st.dataframe(df)
    
    # è©³ç´°æƒ…å ±ã‚’ã‚¨ã‚¯ã‚¹ãƒ‘ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤º
    st.write("### è©³ç´°æƒ…å ±")
    
    # å„ç”»åƒã”ã¨ã«ã‚¨ã‚¯ã‚¹ãƒ‘ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
    for result in results:
        # ç”»åƒåã‚’å–å¾—
        if isinstance(result, dict):
            image_name = result.get('image_name', 'ä¸æ˜')
        else:
            image_name = getattr(result, 'image_name', 'ä¸æ˜')
        
        # ã‚¨ã‚¯ã‚¹ãƒ‘ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‰ã˜ãŸçŠ¶æ…‹ï¼‰
        with st.expander(f"ğŸ“· {image_name}", expanded=False):
            # 3åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¡¨ç¤º
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.write("#### åŸºæœ¬æƒ…å ±")
                
                # ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æçµæœ
                if isinstance(result, dict):
                    style_analysis = result.get('style_analysis', {})
                    if isinstance(style_analysis, dict):
                        category = style_analysis.get('category', '')
                        features = style_analysis.get('features', {})
                    else:
                        category = getattr(style_analysis, 'category', '')
                        features = getattr(style_analysis, 'features', None)
                    
                    # å±æ€§åˆ†æçµæœ
                    attribute_analysis = result.get('attribute_analysis', {})
                    if isinstance(attribute_analysis, dict):
                        sex = attribute_analysis.get('sex', '')
                        length = attribute_analysis.get('length', '')
                    else:
                        sex = getattr(attribute_analysis, 'sex', '')
                        length = getattr(attribute_analysis, 'length', '')
                else:
                    category = getattr(result.style_analysis, 'category', '')
                    features = getattr(result.style_analysis, 'features', None)
                    sex = getattr(result.attribute_analysis, 'sex', '')
                    length = getattr(result.attribute_analysis, 'length', '')
                
                st.write(f"**ã‚«ãƒ†ã‚´ãƒª:** {category}")
                st.write(f"**æ€§åˆ¥:** {sex}")
                st.write(f"**é•·ã•:** {length}")
                
                # ç‰¹å¾´ã®è©³ç´°è¡¨ç¤º
                st.write("#### ã‚¹ã‚¿ã‚¤ãƒ«ç‰¹å¾´")
                if features:
                    if isinstance(features, dict):
                        for key, value in features.items():
                            st.write(f"**{key}:** {value}")
                    else:
                        st.write(f"**è‰²:** {getattr(features, 'color', '')}")
                        st.write(f"**ã‚«ãƒƒãƒˆæŠ€æ³•:** {getattr(features, 'cut_technique', '')}")
                        st.write(f"**ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°:** {getattr(features, 'styling', '')}")
                        st.write(f"**å°è±¡:** {getattr(features, 'impression', '')}")
            
            with col2:
                st.write("#### ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±")
                
                # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±
                if isinstance(result, dict):
                    stylist = result.get('selected_stylist', {})
                    if isinstance(stylist, dict):
                        stylist_name = stylist.get('name', '')
                        specialties = stylist.get('specialties', '')
                        description = stylist.get('description', '')
                    else:
                        stylist_name = getattr(stylist, 'name', '')
                        specialties = getattr(stylist, 'specialties', '')
                        description = getattr(stylist, 'description', '')
                    
                    # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆé¸æŠç†ç”±
                    stylist_reason = result.get('stylist_reason', '')
                else:
                    stylist_name = getattr(result.selected_stylist, 'name', '')
                    specialties = getattr(result.selected_stylist, 'specialties', '')
                    description = getattr(result.selected_stylist, 'description', '')
                    stylist_reason = getattr(result, 'stylist_reason', None)
                
                st.write(f"**ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆå:** {stylist_name}")
                st.write(f"**å¾—æ„ãªæŠ€è¡“ãƒ»ç‰¹å¾´:** {specialties}")
                st.write(f"**èª¬æ˜æ–‡:** {description}")
                
                # é¸æŠç†ç”±ã‚’è¡¨ç¤º
                st.write("#### é¸æŠç†ç”±")
                st.write(stylist_reason or "é¸æŠç†ç”±ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“")
            
            with col3:
                st.write("#### ã‚¯ãƒ¼ãƒãƒ³æƒ…å ±")
                
                # ã‚¯ãƒ¼ãƒãƒ³æƒ…å ±
                if isinstance(result, dict):
                    coupon = result.get('selected_coupon', {})
                    if isinstance(coupon, dict):
                        coupon_name = coupon.get('name', '')
                        price = coupon.get('price', 0)
                        description = coupon.get('description', '')
                    else:
                        coupon_name = getattr(coupon, 'name', '')
                        price = getattr(coupon, 'price', 0)
                        description = getattr(coupon, 'description', '')
                    
                    # ã‚¯ãƒ¼ãƒãƒ³é¸æŠç†ç”±
                    coupon_reason = result.get('coupon_reason', '')
                else:
                    coupon_name = getattr(result.selected_coupon, 'name', '')
                    price = getattr(result.selected_coupon, 'price', 0)
                    description = getattr(result.selected_coupon, 'description', '')
                    coupon_reason = getattr(result, 'coupon_reason', None)
                
                st.write(f"**ã‚¯ãƒ¼ãƒãƒ³å:** {coupon_name}")
                st.write(f"**ä¾¡æ ¼:** {price}å††")
                st.write(f"**èª¬æ˜:** {description}")
                
                # é¸æŠç†ç”±ã‚’è¡¨ç¤º
                st.write("#### é¸æŠç†ç”±")
                st.write(coupon_reason or "é¸æŠç†ç”±ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“")
            

async def fetch_salon_data(url, config_manager):
    """ã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—"""
    if not url:
        st.warning("ã‚µãƒ­ãƒ³URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
        return None, None
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
    cache_dir = Path(os.environ.get("CACHE_DIR", "cache"))
    cache_dir.mkdir(parents=True, exist_ok=True)
    cache_path = cache_dir / "scraper_cache.json"
    
    try:
        # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
        async with ScraperService(
            config=config_manager.scraper,
            cache_path=cache_path
        ) as scraper:
            st.write("ã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...")
            progress_bar = st.progress(0.0)
            
            # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã‚¯ãƒ¼ãƒãƒ³æƒ…å ±ã®å–å¾—
            stylists, coupons = await scraper.fetch_all_data(url)
            
            # çµæœä¿å­˜
            st.session_state[SESSION_STYLISTS] = stylists
            st.session_state[SESSION_COUPONS] = coupons
            
            progress_bar.progress(1.0)
            st.success(f"ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ{len(stylists)}åã€ã‚¯ãƒ¼ãƒãƒ³{len(coupons)}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚")
            
            return stylists, coupons
        
    except Exception as e:
        st.error(f"ã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        return None, None


def render_sidebar(config_manager):
    """ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¡¨ç¤º"""
    with st.sidebar:
        st.title("è¨­å®š")
        
        # ã‚µãƒ­ãƒ³è¨­å®š
        st.header("ã‚µãƒ­ãƒ³è¨­å®š")
        salon_url = st.text_input(
            "ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£URL",
            value=st.session_state.get(SESSION_SALON_URL, config_manager.scraper.base_url),
            help="ã‚µãƒ­ãƒ³ã®ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
        )
        
        # URLã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        if salon_url:
            st.session_state[SESSION_SALON_URL] = salon_url
        
        # ã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒœã‚¿ãƒ³
        if st.button("ã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"):
            # URLã®æ¤œè¨¼
            if not salon_url or not salon_url.startswith("https://beauty.hotpepper.jp/"):
                st.error("æœ‰åŠ¹ãªãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            else:
                # éåŒæœŸã§ã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                asyncio.run(fetch_salon_data(salon_url, config_manager))
        
        # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã‚¯ãƒ¼ãƒãƒ³æƒ…å ±ã‚’è¡¨ç¤º
        if SESSION_STYLISTS in st.session_state and SESSION_COUPONS in st.session_state:
            stylists = st.session_state[SESSION_STYLISTS]
            coupons = st.session_state[SESSION_COUPONS]
            
            if stylists:
                st.write(f"ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ: {len(stylists)}äºº")
                stylist_expander = st.expander("ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆä¸€è¦§")
                with stylist_expander:
                    for i, stylist in enumerate(stylists[:10]):  # è¡¨ç¤ºæ•°ã‚’åˆ¶é™
                        st.write(f"{i+1}. {stylist.name}")
                    if len(stylists) > 10:
                        st.write(f"...ä»– {len(stylists) - 10}äºº")
            
            if coupons:
                st.write(f"ã‚¯ãƒ¼ãƒãƒ³: {len(coupons)}ä»¶")
                coupon_expander = st.expander("ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§")
                with coupon_expander:
                    for i, coupon in enumerate(coupons[:10]):  # è¡¨ç¤ºæ•°ã‚’åˆ¶é™
                        st.write(f"{i+1}. {coupon.name}")
                    if len(coupons) > 10:
                        st.write(f"...ä»– {len(coupons) - 10}ä»¶")
        
        # è©³ç´°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
        st.header("è©³ç´°è¨­å®š")
        with st.expander("è©³ç´°è¨­å®š"):
            # ãƒãƒƒãƒã‚µã‚¤ã‚ºè¨­å®š
            batch_size = st.slider(
                "ãƒãƒƒãƒã‚µã‚¤ã‚º",
                min_value=1,
                max_value=10,
                value=config_manager.processing.batch_size,
                help="ä¸€åº¦ã«å‡¦ç†ã™ã‚‹ç”»åƒã®æ•°ã§ã™ã€‚å¤§ãã™ãã‚‹ã¨ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            )
            
            # APIé…å»¶è¨­å®š
            api_delay = st.slider(
                "APIé…å»¶ï¼ˆç§’ï¼‰",
                min_value=0.1,
                max_value=5.0,
                value=config_manager.processing.api_delay,
                step=0.1,
                help="APIå‘¼ã³å‡ºã—é–“ã®é…å»¶æ™‚é–“ã§ã™ã€‚å°ã•ã™ãã‚‹ã¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            )
            
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLè¨­å®š
            cache_ttl_days = st.slider(
                "ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé–“ï¼ˆæ—¥ï¼‰",
                min_value=1,
                max_value=30,
                value=config_manager.cache.ttl_days,
                help="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé–“ã§ã™ã€‚é•·ã™ãã‚‹ã¨å¤ã„çµæœãŒè¿”ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            )
            
            # è¨­å®šã‚’ä¿å­˜
            if st.button("è¨­å®šã‚’ä¿å­˜"):
                try:
                    # è¨­å®šã®æ›´æ–°
                    config_updates = {
                        "processing": {
                            "batch_size": batch_size,
                            "api_delay": api_delay
                        },
                        "cache": {
                            "ttl_days": cache_ttl_days
                        }
                    }
                    
                    # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼URLã®æ›´æ–°
                    if salon_url:
                        config_updates["scraper"] = {
                            "base_url": salon_url
                        }
                    
                    # è¨­å®šã®æ›´æ–°
                    config_manager.update_config(config_updates)
                    
                    st.success("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚")
                
                except Exception as e:
                    st.error(f"è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        st.header("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†")
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®š
        use_cache = st.checkbox(
            "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹",
            value=st.session_state.get(SESSION_USE_CACHE, True),
            help="ã‚ªãƒ•ã«ã™ã‚‹ã¨æ¯å›APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆæ™‚ãªã©ã«æœ‰ç”¨ã§ã™ã€‚"
        )
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®šã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        st.session_state[SESSION_USE_CACHE] = use_cache
        
        # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯è¨­å®šã‚’æ›´æ–°
        if SESSION_PROCESSOR in st.session_state and st.session_state[SESSION_PROCESSOR] is not None:
            processor = st.session_state[SESSION_PROCESSOR]
            processor.set_use_cache(use_cache)
            st.session_state[SESSION_PROCESSOR] = processor
        

def render_main_content():
    """ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º"""
    st.title("ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æãƒ„ãƒ¼ãƒ«")
    
    # APIã‚­ãƒ¼ã®ç¢ºèª
    api_key = get_api_key()
    if not api_key and SESSION_API_WARNING not in st.session_state:
        st.warning(
            "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚"
            "\n\n"
            "APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š\n"
            "1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`GEMINI_API_KEY=your_api_key`ã‚’è¿½åŠ \n"
            "2. `.streamlit/secrets.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`GEMINI_API_KEY = \"your_api_key\"`ã‚’è¿½åŠ "
        )
        st.session_state[SESSION_API_WARNING] = True
    
    # èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ
    st.markdown("""
    ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«ç”»åƒã‚’åˆ†æã—ã€æœ€é©ãªã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã€ã‚¯ãƒ¼ãƒãƒ³ã‚’ææ¡ˆã—ã¾ã™ã€‚
    ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Œã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
    """)
    
    # ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰éƒ¨åˆ†
    uploaded_files = st.file_uploader(
        "ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„",
        type=["png", "jpg", "jpeg"],
        accept_multiple_files=True,
        help="PNG, JPG, JPEGãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚"
    )
    
    # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    if uploaded_files:
        st.write(f"{len(uploaded_files)}æšã®ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ")
        
        # ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆæ¨ªã«ä¸¦ã¹ã‚‹ï¼‰- åˆ—æ•°ã‚’4ã«å¢—ã‚„ã—ã€ç”»åƒã‚µã‚¤ã‚ºã‚’åˆ¶é™
        cols = st.columns(min(4, len(uploaded_files)))
        for i, uploaded_file in enumerate(uploaded_files[:8]):  # æœ€å¤§8æšã¾ã§è¡¨ç¤º
            with cols[i % 4]:
                # ç”»åƒã‚’é–‹ã„ã¦ãƒªã‚µã‚¤ã‚º
                image = Image.open(uploaded_file)
                # ç”»åƒã®æœ€å¤§å¹…ã‚’200pxã«åˆ¶é™
                st.image(image, caption=uploaded_file.name, width=200)
        
        # 8æšä»¥ä¸Šã®å ´åˆã¯çœç•¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if len(uploaded_files) > 8:
            st.write(f"ä»– {len(uploaded_files) - 8} æšã®ç”»åƒã¯çœç•¥ã•ã‚Œã¦ã„ã¾ã™")
        
        # å‡¦ç†é–‹å§‹ãƒœã‚¿ãƒ³
        if st.button("ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ", type="primary"):
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’å–å¾—ã¾ãŸã¯åˆæœŸåŒ–
            try:
                # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if SESSION_PROCESSOR not in st.session_state or st.session_state[SESSION_PROCESSOR] is None:
                    logging.info("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã—ãªã„ãŸã‚ã€æ–°è¦ä½œæˆã—ã¾ã™")
                    config_manager = get_config_manager()
                    processor = create_processor(config_manager)
                    
                    # åˆæœŸåŒ–ã«æˆåŠŸã—ãŸã‹ç¢ºèª
                    if processor is None:
                        st.error("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                        return
                    
                    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
                    st.session_state[SESSION_PROCESSOR] = processor
                    logging.info("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ")
                else:
                    processor = st.session_state[SESSION_PROCESSOR]
                    logging.info("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’å–å¾—ã—ã¾ã—ãŸ")
                
                # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”»åƒã‚’ä¿å­˜
                temp_dir = Path(os.environ.get("TEMP_DIR", "temp")) / "hairstyle_analyzer"
                temp_dir.mkdir(parents=True, exist_ok=True)
                image_paths = handle_image_upload(uploaded_files)
                
                if not image_paths:
                    st.error("ç”»åƒã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
                    return
                
                logging.info(f"{len(image_paths)}æšã®ç”»åƒã‚’ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¾ã—ãŸ")
                
                # APIã‚­ãƒ¼ã®ç¢ºèªã¨è­¦å‘Šè¡¨ç¤º
                api_key = get_api_key()
                if not api_key:
                    st.warning("""
                    **Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€AIåˆ†ææ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚**
                    
                    ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã‚’ç¶šè¡Œã—ã¾ã™ã€‚å®Œå…¨ãªæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
                    1. `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«`GEMINI_API_KEY=your_api_key_here`ã‚’è¿½åŠ 
                    2. `.streamlit/secrets.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã«`GEMINI_API_KEY = "your_api_key_here"`ã‚’è¿½åŠ 
                    
                    APIã‚­ãƒ¼ã‚’è¨­å®šã—ãŸã‚‰ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                    """)
                
                # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¡¨ç¤º
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                # åˆæœŸåŒ–
                processor = st.session_state[SESSION_PROCESSOR]
                
                # éåŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œ
                with st.spinner("ç”»åƒã‚’å‡¦ç†ä¸­..."):
                    # é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
                    def update_progress(current, total):
                        progress = float(current) / float(total)
                        progress_bar.progress(progress)
                        status_text.text(f"å‡¦ç†ä¸­: {current}/{total} ({int(progress * 100)}%)")
                    
                    # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã‚¯ãƒ¼ãƒãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    stylists = st.session_state.get(SESSION_STYLISTS, [])
                    coupons = st.session_state.get(SESSION_COUPONS, [])
                    
                    # ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã‚¯ãƒ¼ãƒãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    if not stylists:
                        st.warning("ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±ãŒå–å¾—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚")
                    if not coupons:
                        st.warning("ã‚¯ãƒ¼ãƒãƒ³æƒ…å ±ãŒå–å¾—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œã‚µãƒ­ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚")
                    
                    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®šã®å–å¾—
                    use_cache = st.session_state.get(SESSION_USE_CACHE, True)
                    
                    # å‡¦ç†ã®å®Ÿè¡Œï¼ˆã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã‚¯ãƒ¼ãƒãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã‚’æ¸¡ã™ï¼‰
                    results = asyncio.run(process_images(processor, image_paths, stylists, coupons, use_cache))
                    
                    # å‡¦ç†å®Œäº†
                    progress_bar.progress(1.0)
                    status_text.text("å‡¦ç†å®Œäº†ï¼")
                    
                    # çµæœãŒç©ºã§ãªã„ã‹ç¢ºèª
                    if not results:
                        st.error("ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                        return
                    
                    # çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
                    st.session_state[SESSION_RESULTS] = results
                    
                    # çµæœè¡¨ç¤º
                    display_results(results)
                    
                    # ã“ã“ã‹ã‚‰Excelå‡ºåŠ›å‡¦ç†ã‚’è¿½åŠ 
                    try:
                        # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
                        processor = st.session_state[SESSION_PROCESSOR]
                        
                        # Excelå‡ºåŠ›ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤º
                        generate_excel_download(processor, results, "ã‚¿ã‚¤ãƒˆãƒ«ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚")
                    
                    except Exception as e:
                        logging.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                        import traceback
                        logging.error(traceback.format_exc())
                        st.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            
            except Exception as e:
                st.error(f"å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                logging.error(f"å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                import traceback
                logging.error(traceback.format_exc())
    
    # çµæœãŒæ—¢ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚ã‚‹å ´åˆã¯è¡¨ç¤º
    elif SESSION_RESULTS in st.session_state and st.session_state[SESSION_RESULTS]:
        results = st.session_state[SESSION_RESULTS]
        display_results(results)
        
        # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        if SESSION_PROCESSOR in st.session_state and st.session_state[SESSION_PROCESSOR] is not None:
            try:
                # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’å–å¾—
                processor = st.session_state[SESSION_PROCESSOR]
                
                # Excelå‡ºåŠ›ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤º
                generate_excel_download(processor, results, "ä»¥å‰ã®å‡¦ç†çµæœã‹ã‚‰Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚")
                
            except Exception as e:
                logging.error(f"æ—¢å­˜çµæœã‹ã‚‰ã®Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                import traceback
                logging.error(traceback.format_exc())
                st.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")


def get_config_manager():
    """è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã™ã‚‹"""
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    if SESSION_CONFIG in st.session_state:
        return st.session_state[SESSION_CONFIG]
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
    config_manager = ConfigManager("config/config.yaml")
    st.session_state[SESSION_CONFIG] = config_manager
    return config_manager


def handle_image_upload(uploaded_files):
    """ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹é–¢æ•°"""
    if not uploaded_files:
        return []
    
    try:
        # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
        temp_dir = Path(os.environ.get("TEMP_DIR", "temp")) / "hairstyle_analyzer"
        temp_dir.mkdir(parents=True, exist_ok=True)
        
        # å‰å›ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        try:
            for old_file in temp_dir.glob("*"):
                if old_file.is_file():
                    old_file.unlink()
            logging.info("å‰å›ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ")
        except Exception as e:
            logging.warning(f"ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼: {str(e)}")
        
        # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜
        image_paths = []
        for i, file in enumerate(uploaded_files):
            try:
                # ãƒ•ã‚¡ã‚¤ãƒ«åã®å–å¾—ï¼ˆæ‹¡å¼µå­ã‚’å«ã‚€ï¼‰
                original_filename = file.name
                file_ext = Path(original_filename).suffix.lower()
                
                # ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®æ¤œè¨¼
                if file_ext not in ['.jpg', '.jpeg', '.png']:
                    logging.warning(f"ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: {file_ext}")
                    continue
                
                # å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ
                safe_filename = f"styleimg_{i+1}{file_ext}"
                temp_path = temp_dir / safe_filename
                
                # ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜
                with open(temp_path, "wb") as f:
                    f.write(file.getbuffer())
                
                # ç”»åƒã®æ¤œè¨¼
                try:
                    img = Image.open(temp_path)
                    img.verify()  # ç”»åƒãŒæœ‰åŠ¹ã‹æ¤œè¨¼
                    img.close()
                    # å†åº¦é–‹ã„ã¦ã‚µã‚¤ã‚ºã‚’ç¢ºèª
                    with Image.open(temp_path) as img:
                        width, height = img.size
                        if width <= 0 or height <= 0:
                            logging.warning(f"ç„¡åŠ¹ãªç”»åƒã‚µã‚¤ã‚º: {width}x{height}, ãƒ•ã‚¡ã‚¤ãƒ«: {safe_filename}")
                            continue
                        logging.info(f"ç”»åƒã‚µã‚¤ã‚º: {width}x{height}, ãƒ•ã‚¡ã‚¤ãƒ«: {safe_filename}")
                except Exception as e:
                    logging.error(f"ç”»åƒæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ ({safe_filename}): {str(e)}")
                    continue
                
                # æˆåŠŸã—ãŸå ´åˆã€ãƒ‘ã‚¹ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆæ–‡å­—åˆ—ã¨ã—ã¦ï¼‰
                image_paths.append(str(temp_path))
                logging.info(f"ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ: {original_filename} -> {safe_filename}")
                
            except Exception as e:
                logging.error(f"ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {str(e)}")
                import traceback
                logging.error(traceback.format_exc())
                continue
        
        return image_paths
        
    except Exception as e:
        logging.error(f"ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…¨ä½“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        import traceback
        logging.error(traceback.format_exc())
        return []


def get_api_key():
    """APIã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°"""
    try:
        # Streamlit Secretsã‹ã‚‰ã®å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ‘åˆ¶ï¼‰
        try:
            if "GEMINI_API_KEY" in st.secrets:
                api_key = st.secrets["GEMINI_API_KEY"]
                logging.info("Streamlit Secretsã‹ã‚‰ã®ã‚­ãƒ¼å–å¾—: æˆåŠŸ")
                return api_key
        except Exception as e:
            # st.secretsã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶ã—ã€è©³ç´°ã‚’ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã§ã®ã¿ãƒ­ã‚°ã«è¨˜éŒ²
            logging.debug(f"Streamlit Secretsã‹ã‚‰ã®ã‚­ãƒ¼å–å¾—ã«å¤±æ•—: {str(e)}")
            # ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã›ãšã€æ¬¡ã®æ–¹æ³•ã‚’è©¦ã¿ã‚‹
        
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®å–å¾—ã‚’è©¦ã¿ã‚‹
        if "GEMINI_API_KEY" in os.environ:
            api_key = os.environ["GEMINI_API_KEY"]
            logging.info("ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®ã‚­ãƒ¼å–å¾—: æˆåŠŸ")
            return api_key
        
        # APIã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®å‡¦ç†
        logging.warning("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’è¡¨ç¤ºï¼ˆAPIã‚­ãƒ¼ãŒãªãã¦ã‚‚ä»–ã®æ©Ÿèƒ½ã¯ä½¿ãˆã‚‹ï¼‰
        print("æ³¨æ„: GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸€éƒ¨ã®æ©Ÿèƒ½ã¯åˆ¶é™ã•ã‚Œã¾ã™ã€‚")
        print("APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:")
        print("1. .streamlit/secrets.tomlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ (.streamlitãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ä½œæˆã—ã€ãã®ä¸­ã«secrets.tomlã‚’ä½œæˆ)")
        print("2. .envãƒ•ã‚¡ã‚¤ãƒ«ã«GEMINI_API_KEY=ã‚ãªãŸã®ã‚­ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ)")
        print("è©³ç´°ã¯STREAMLIT_DEPLOY.mdã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚")
        
        return None
            
    except Exception as e:
        logging.error(f"APIã‚­ãƒ¼å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        return None


def run_streamlit_app(skip_page_config=False):
    """Streamlit ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™"""
    # è¨­å®šãƒšãƒ¼ã‚¸
    if not skip_page_config:
        st.set_page_config(
            page_title="ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æãƒ„ãƒ¼ãƒ«",
            page_icon="âœ‚ï¸",
            layout="wide"
        )
    
    # åˆæœŸè¨­å®š
    initialize_session_state()
    setup_logging()
    
    # è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å–å¾—ã¾ãŸã¯åˆæœŸåŒ–
    config_manager = st.session_state.get(SESSION_CONFIG)
    if not config_manager:
        from hairstyle_analyzer.config.config_manager import ConfigManager
        config_manager = ConfigManager()
        st.session_state[SESSION_CONFIG] = config_manager
        logging.info("è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¹ã‚¿ã‚¤ãƒ«
    st.title("ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æãƒ„ãƒ¼ãƒ«")
    load_styles()
    
    # APIã‚­ãƒ¼ã®ç¢ºèª
    api_key = get_api_key()
    if not api_key and SESSION_API_WARNING not in st.session_state:
        st.warning(
            "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚"
            "\n\n"
            "APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š\n"
            "1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`GEMINI_API_KEY=your_api_key`ã‚’è¿½åŠ \n"
            "2. `.streamlit/secrets.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`GEMINI_API_KEY = \"your_api_key\"`ã‚’è¿½åŠ "
        )
        st.session_state[SESSION_API_WARNING] = True
    
    # ã‚¿ãƒ–ã®è¨­å®š
    tab1, tab2 = st.tabs(["ç”»åƒåˆ†æ", "è¨­å®š"])
    
    # ã‚¿ãƒ–1: ç”»åƒåˆ†æã‚¿ãƒ–
    with tab1:
        # ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨å‡¦ç†
        uploaded_files = st.file_uploader("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", 
                                          type=["png", "jpg", "jpeg"], 
                                          accept_multiple_files=True,
                                          key=SESSION_UPLOADER)
        
        # æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢
        info_area = st.empty()
        
        # ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒœã‚¿ãƒ³
        if st.button("ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ", disabled=len(get_uploaded_images()) == 0):
            # APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            api_key = get_api_key()
            if not api_key:
                st.error(
                    "Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¿ã‚¤ãƒˆãƒ«ç”ŸæˆãŒã§ãã¾ã›ã‚“ã€‚"
                    "\n\n"
                    "APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š\n"
                    "1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`GEMINI_API_KEY=your_api_key`ã‚’è¿½åŠ \n"
                    "2. `.streamlit/secrets.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`GEMINI_API_KEY = \"your_api_key\"`ã‚’è¿½åŠ "
                )
            else:
                # ç”»åƒå‡¦ç†ã®å®Ÿè¡Œ
                process_uploaded_images()
            
        # çµæœè¡¨ç¤º
        display_results()
    
    # ã‚¿ãƒ–2: è¨­å®šã‚¿ãƒ–
    with tab2:
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨è¨­å®š
        use_cache = st.checkbox("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹", 
                                value=st.session_state.get(SESSION_USE_CACHE, True),
                                key=SESSION_USE_CACHE)
        
        st.write("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åŒã˜ç”»åƒã«å¯¾ã™ã‚‹åˆ†æçµæœãŒå†åˆ©ç”¨ã•ã‚Œã€å‡¦ç†æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã¾ã™ã€‚")
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
        if st.button("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢"):
            clear_cache()
            st.success("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
        
        # ã‚¢ãƒ—ãƒªæƒ…å ±
        st.markdown("---")
        st.markdown("### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±")
        st.markdown(f"ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {APP_VERSION}")
        
        # é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰
        st.markdown("---")
        st.markdown("### é–‹ç™ºè€…è¨­å®š")
        dev_mode = st.checkbox("é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰", 
                              value=st.session_state.get(SESSION_DEV_MODE, False),
                              key=SESSION_DEV_MODE)
        
        if dev_mode:
            if st.button("ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢"):
                clear_session_state()
                st.experimental_rerun()
                
            st.markdown("#### ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹")
            st.json({k: str(v) if not isinstance(v, (int, float, str, bool, type(None))) else v 
                    for k, v in st.session_state.items()})
            
            # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼æƒ…å ±
            st.markdown("#### ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼æƒ…å ±")
            processor = st.session_state.get(SESSION_PROCESSOR)
            if processor:
                st.write(f"ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼: {type(processor).__name__}")
                st.write(f"ç”»åƒã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼: {type(processor.image_analyzer).__name__}")
                st.write(f"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ£ãƒ¼: {type(processor.template_matcher).__name__}")
                st.write(f"ã‚¹ã‚¿ã‚¤ãƒ«ãƒãƒƒãƒãƒ£ãƒ¼: {type(processor.style_matcher).__name__}")
            else:
                st.write("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã¯åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")


if __name__ == "__main__":
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
    run_streamlit_app()

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°
def display_error(e):
    """ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã™ã‚‹"""
    error_message = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
    logging.error(error_message)
    st.error(error_message)


class StreamlitErrorHandler:
    """Streamlitç”¨ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹"""
    def __init__(self):
        self.error_occurred = False
        self.error_message = ""
    
    def __enter__(self):
        self.error_occurred = False
        self.error_message = ""
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if exc_type:
            self.error_occurred = True
            self.error_message = str(exc_val)
            logging.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {exc_type.__name__}: {exc_val}")
            import traceback
            logging.error(traceback.format_exc())
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {exc_val}")
            return True  # ä¾‹å¤–ã‚’å‡¦ç†æ¸ˆã¿ã¨ã™ã‚‹
        return False


def convert_to_process_results(results):
    """è¾æ›¸å‹ã®çµæœã‚’ProcessResultã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹é–¢æ•°"""
    process_results = []
    
    for result in results:
        if isinstance(result, dict):
            # è¾æ›¸å‹ã®å ´åˆã€ProcessResultã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
            
            # style_analysisã®å–å¾—ã¨å¤‰æ›
            style_analysis_dict = result.get('style_analysis', {})
            if isinstance(style_analysis_dict, dict):
                style_analysis = StyleAnalysis(
                    category=style_analysis_dict.get('category', ''),
                    features=style_analysis_dict.get('features', []),
                    colors=style_analysis_dict.get('colors', []),
                    textures=style_analysis_dict.get('textures', [])
                )
            else:
                style_analysis = style_analysis_dict
            
            # attribute_analysisã®å–å¾—ã¨å¤‰æ›
            attribute_analysis_dict = result.get('attribute_analysis', {})
            if isinstance(attribute_analysis_dict, dict):
                attribute_analysis = AttributeAnalysis(
                    sex=attribute_analysis_dict.get('sex', ''),
                    length=attribute_analysis_dict.get('length', '')
                )
            else:
                attribute_analysis = attribute_analysis_dict
            
            # selected_templateã®å–å¾—ã¨å¤‰æ›
            template_dict = result.get('selected_template', {})
            if isinstance(template_dict, dict):
                template = Template(
                    category=template_dict.get('category', ''),
                    title=template_dict.get('title', ''),
                    menu=template_dict.get('menu', ''),
                    comment=template_dict.get('comment', ''),
                    hashtag=template_dict.get('hashtag', '')
                )
            else:
                template = template_dict
            
            # selected_stylistã®å–å¾—ã¨å¤‰æ›
            stylist_dict = result.get('selected_stylist', {})
            if isinstance(stylist_dict, dict):
                stylist = StylistInfo(
                    name=stylist_dict.get('name', ''),
                    specialties=stylist_dict.get('specialties', ''),
                    description=stylist_dict.get('description', '')
                )
            else:
                stylist = stylist_dict
            
            # selected_couponã®å–å¾—ã¨å¤‰æ›
            coupon_dict = result.get('selected_coupon', {})
            if isinstance(coupon_dict, dict):
                coupon = CouponInfo(
                    name=coupon_dict.get('name', ''),
                    price=coupon_dict.get('price', 0),
                    description=coupon_dict.get('description', ''),
                    categories=coupon_dict.get('categories', []),
                    conditions=coupon_dict.get('conditions', {})
                )
            else:
                coupon = coupon_dict
            
            # ProcessResultã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
            process_result = ProcessResult(
                image_name=result.get('image_name', 'ä¸æ˜'),
                style_analysis=style_analysis,
                attribute_analysis=attribute_analysis,
                selected_template=template,
                selected_stylist=stylist,
                selected_coupon=coupon,
                processed_at=result.get('processed_at', datetime.now())
            )
            
            process_results.append(process_result)
        else:
            # ã™ã§ã«ProcessResultã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ãã®ã¾ã¾è¿½åŠ 
            process_results.append(result)
    
    return process_results

def generate_excel_download(processor, results, title="ã‚¿ã‚¤ãƒˆãƒ«ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚"):
    """ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’ä½¿ç”¨ã—ã¦Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°"""
    try:
        # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®çµæœã‚’ã‚¯ãƒªã‚¢
        processor.clear_results()
        
        # çµæœã‚’ProcessResultã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã«è¿½åŠ 
        process_results = convert_to_process_results(results)
        processor.results.extend(process_results)
        
        # Excelãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        excel_bytes = processor.get_excel_binary()
        
        # Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"hairstyle_analysis_{timestamp}.xlsx"
        
        # é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        st.success(f"{title}ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
        
        # ç›®ç«‹ã¤ã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            st.download_button(
                label="â¬‡ï¸ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â¬‡ï¸",
                data=excel_bytes,
                file_name=filename,
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                help="ã‚¯ãƒªãƒƒã‚¯ã—ã¦Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                type="primary",
                use_container_width=True
            )
        
        # å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ 
        st.write("")
        
        return True
    
    except Exception as e:
        logging.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        import traceback
        logging.error(traceback.format_exc())
        st.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        return False


def clear_session_state():
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹"""
    # ä¿æŒã™ã‚‹å¿…è¦ã®ã‚ã‚‹è¨­å®šã‚’ä¸€æ™‚ä¿å­˜
    config = st.session_state.get(SESSION_CONFIG)
    use_cache = st.session_state.get(SESSION_USE_CACHE, True)
    salon_url = st.session_state.get(SESSION_SALON_URL, "")
    dev_mode = st.session_state.get(SESSION_DEV_MODE, False)
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    for key in list(st.session_state.keys()):
        del st.session_state[key]
    
    # å¿…è¦ãªè¨­å®šã‚’å¾©å…ƒ
    st.session_state[SESSION_CONFIG] = config
    st.session_state[SESSION_USE_CACHE] = use_cache
    st.session_state[SESSION_SALON_URL] = salon_url
    st.session_state[SESSION_DEV_MODE] = dev_mode
    
    # åŸºæœ¬çš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’å†åˆæœŸåŒ–
    initialize_session_state()


def get_uploaded_images():
    """ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã®ä¸€è¦§ã‚’å–å¾—"""
    if SESSION_UPLOADER not in st.session_state or not st.session_state[SESSION_UPLOADER]:
        return []
    
    uploaded_files = st.session_state[SESSION_UPLOADER]
    if not uploaded_files:
        return []
    
    return uploaded_files

def process_uploaded_images():
    """ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’å‡¦ç†"""
    uploaded_files = get_uploaded_images()
    if not uploaded_files:
        st.warning("ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        return
    
    # å‡¦ç†ä¸­ã®çŠ¶æ…‹ã‚’è¨­å®š
    st.session_state[SESSION_PROCESSING] = True
    st.session_state[SESSION_PROCESSED] = False
    st.session_state[SESSION_RESULTS] = {}
    
    # è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å–å¾—
    config_manager = st.session_state.get(SESSION_CONFIG)
    if not config_manager:
        st.error("è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.session_state[SESSION_PROCESSING] = False
        return
    
    # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®å–å¾—ãƒ»ä½œæˆ
    processor = st.session_state.get(SESSION_PROCESSOR)
    if not processor:
        processor = create_processor(config_manager)
        if not processor:
            st.error("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
            st.session_state[SESSION_PROCESSING] = False
            return
        st.session_state[SESSION_PROCESSOR] = processor
    
    # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®åˆæœŸåŒ–
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    try:
        # ç”»åƒã®å‡¦ç†
        results = {}
        total_files = len(uploaded_files)
        
        for idx, uploaded_file in enumerate(uploaded_files):
            # é€²æ—çŠ¶æ³ã®æ›´æ–°
            progress = (idx / total_files)
            progress_bar.progress(progress)
            status_text.text(f"å‡¦ç†ä¸­... ({idx+1}/{total_files})")
            
            # ç”»åƒãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            try:
                image_bytes = uploaded_file.getvalue()
                filename = uploaded_file.name
                image_data = ImageData(
                    content=image_bytes,
                    filename=filename,
                    file_id=f"img_{idx+1}"
                )
                
                # ç”»åƒã®å‡¦ç†
                result = process_image(processor, image_data)
                if result:
                    results[filename] = result
            except Exception as e:
                logging.error(f"ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼ ({filename}): {str(e)}")
                st.error(f"ç”»åƒã€Œ{filename}ã€ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        
        # å‡¦ç†å®Œäº†
        progress_bar.progress(1.0)
        status_text.text("å‡¦ç†å®Œäº†!")
        
        # çµæœã®ä¿å­˜
        st.session_state[SESSION_RESULTS] = results
        st.session_state[SESSION_PROCESSED] = True
        
        # çµæœãŒã‚ã‚‹ã‹ç¢ºèª
        if not results:
            st.warning("å‡¦ç†çµæœãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚APIã‚­ãƒ¼ã®è¨­å®šã¨ç”»åƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    except Exception as e:
        logging.error(f"å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        st.error(f"å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
    finally:
        # å‡¦ç†çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
        st.session_state[SESSION_PROCESSING] = False

def process_image(processor, image_data):
    """å˜ä¸€ç”»åƒã‚’å‡¦ç†"""
    if not processor:
        logging.error("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return None
    
    try:
        result = processor.process_single_image(image_data)
        return result
    except Exception as e:
        logging.error(f"ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼ ({image_data.filename}): {str(e)}")
        return None

def display_results():
    """å‡¦ç†çµæœã®è¡¨ç¤º"""
    if not st.session_state.get(SESSION_PROCESSED, False):
        return
    
    results = st.session_state.get(SESSION_RESULTS, {})
    if not results:
        st.warning("è¡¨ç¤ºã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return
    
    # çµæœã®è¡¨ç¤º
    st.subheader("åˆ†æçµæœ")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆ
    data = []
    for filename, result in results.items():
        if not result or not hasattr(result, 'title') or not hasattr(result, 'image_data'):
            continue
        
        # ç”»åƒã®è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        image_bytes = result.image_data.content
        
        data.append({
            "ãƒ•ã‚¡ã‚¤ãƒ«å": filename,
            "ç”Ÿæˆã‚¿ã‚¤ãƒˆãƒ«": result.title,
            "ç”»åƒãƒ‡ãƒ¼ã‚¿": image_bytes
        })
    
    if not data:
        st.warning("è¡¨ç¤ºå¯èƒ½ãªçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆã¨è¡¨ç¤º
    df = pd.DataFrame(data)
    
    # å„è¡Œã®è¡¨ç¤º
    for i, row in df.iterrows():
        col1, col2 = st.columns([1, 2])
        
        # ç”»åƒã®è¡¨ç¤º
        with col1:
            try:
                image = Image.open(io.BytesIO(row["ç”»åƒãƒ‡ãƒ¼ã‚¿"]))
                st.image(image, caption=row["ãƒ•ã‚¡ã‚¤ãƒ«å"], use_column_width=True)
            except Exception as e:
                st.error(f"ç”»åƒã®è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: {str(e)}")
        
        # ã‚¿ã‚¤ãƒˆãƒ«ã®è¡¨ç¤º
        with col2:
            st.markdown(f"### ç”Ÿæˆã‚¿ã‚¤ãƒˆãƒ«")
            st.write(row["ç”Ÿæˆã‚¿ã‚¤ãƒˆãƒ«"])
    
    # Excelå‡ºåŠ›ãƒœã‚¿ãƒ³
    if st.button("Excelå‡ºåŠ›"):
        excel_data = generate_excel()
        if excel_data:
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤º
            now = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"hairstyle_results_{now}.xlsx"
            
            st.download_button(
                label="Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=excel_data,
                file_name=filename,
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
            
            st.success(f"Excelãƒ•ã‚¡ã‚¤ãƒ« '{filename}' ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚")

def load_styles():
    """CSSã‚¹ã‚¿ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿"""
    st.markdown("""
    <style>
    .main .block-container {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    h1 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
    }
    h2 {
        color: #3498db;
        margin-top: 1.5rem;
    }
    .stButton > button {
        background-color: #3498db;
        color: white;
        font-weight: bold;
    }
    .stButton > button:hover {
        background-color: #2980b9;
    }
    .success {
        color: #27ae60;
        font-weight: bold;
    }
    .error {
        color: #e74c3c;
        font-weight: bold;
    }
    </style>
    """, unsafe_allow_html=True)

def clear_cache():
    """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢"""
    try:
        # è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’å–å¾—
        config_manager = st.session_state.get(SESSION_CONFIG)
        if not config_manager:
            st.error("è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            return
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        cache_manager = CacheManager(config_manager.paths.cache_file, config_manager.cache)
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢
        cache_manager.clear_cache()
        logging.info("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
        return True
    except Exception as e:
        logging.error(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        return False

def generate_excel():
    """Excelãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ"""
    try:
        # è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å–å¾—
        config_manager = st.session_state.get(SESSION_CONFIG)
        if not config_manager:
            st.error("è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            return None
        
        # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã®å–å¾—
        processor = st.session_state.get(SESSION_PROCESSOR)
        if not processor:
            st.error("ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            return None
        
        # çµæœãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        results = st.session_state.get(SESSION_RESULTS, {})
        if not results:
            st.warning("Excelå‡ºåŠ›ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
            return None
        
        # ãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
        result_list = list(results.values())
        
        # ã‚µãƒ­ãƒ³URLå–å¾—
        salon_url = st.session_state.get(SESSION_SALON_URL, "")
        
        # Excelç”Ÿæˆ
        try:
            excel_bytes = processor.excel_exporter.generate_excel(
                results=result_list,
                salon_url=salon_url
            )
            return excel_bytes
        except Exception as e:
            logging.error(f"Excelç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
            st.error(f"Excelç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            return None
    except Exception as e:
        logging.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        st.error(f"Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        return None
